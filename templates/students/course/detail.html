{% extends "base.html" %}
{% block title %}
  {{ object.title }}
{% endblock %}
{% block content %}
  <h1>
    {{ module.title }}
  </h1>
  <div class="contents">
    <h3>Modules ({{ progress }}% done)</h3>
    <ul id="modules">
      {% for m in object.modules.all %}
        <li data-id="{{ m.id }}" class="module_list_item" {% if m == module %} class="selected"{% endif %}>
          <a href="{% url "student_course_detail_module" object.id m.id %}">
            <span>
              Module <span class="order">{{ m.order|add:1 }}</span>
            </span>
            <br>
            {{ m.title }}
          </a>
        </li>
      {% empty %}
        <li>No modules yet.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="module">
    {% for content in module.contents.all %}
      {% with item=content.item %}
              <h2>{{ item.title }}</h2>
              {{ item.render }}

      {% endwith %}
    {% endfor %}

  <p>Discussion:</p>
      <form action="{% url 'add_comment' module.id %}" method="POST">
          {% csrf_token %}
          {{ new_comment_form.as_p }}
          <input type="submit" value="Leave comment">
      </form>
    <div id="comments">
    </div>
  </div>



        <script>
        let tests = document.getElementsByClassName("test");

        let current_url = window.location.href
        const request_check_module = new XMLHttpRequest();
        let module_id = "";
        if (current_url.split("/")[6] === ""){
             module_id = "1";
        } else {
             module_id =  current_url.split("/")[6];
        }

        const module_check_url = "http://127.0.0.1:8000/course/module/" + module_id + "/process_finished/";
        request_check_module.open('GET', module_check_url);
        request_check_module.setRequestHeader('Content-Type', 'text/html');

        request_check_module.addEventListener("readystatechange", () => {
            if (request_check_module.readyState === 4 && request_check_module.status === 200) {
                console.log("Request was sent.");
            }
        });
        request_check_module.send();
        for(let i=0; i < tests.length; i++) {
            // Создаём объект класса XMLHttpRequest
            const request = new XMLHttpRequest();

            const url = "http://127.0.0.1:8000/course/check_test_was_done/" + tests[i].id;

            request.open('GET', url);
            request.setRequestHeader('Content-Type', 'application/json');
            request.addEventListener("readystatechange", () => {
                if (request.readyState === 4 && request.status === 200) {
                    let resp = JSON.parse(request.response);
                    if (resp["status"] !== "not_done") {
                        let inputs = tests[i].getElementsByTagName("input");
                        for (let j=0; j < Object.keys(resp["answers"]).length; j++) {
                            let key = Object.keys(resp["answers"])[j].toString();
                            let check_box = document.getElementsByName(key)[0];

                            if (resp["answers"][key] === true) {
                                check_box.checked = true;
                            }
                        }

                        if (resp["status"] === "wrong") {
                            tests[i].style.backgroundColor = "#ffa8a8";
                        } else if (resp["status"] === "right") {
                            tests[i].style.backgroundColor = "#8affad";
                            tests[i].style.opacity = 0.5;
                            for (let j = 0; j < inputs.length; j++) {
                                inputs[j].disabled = true;
                            }
                        }
                    }

                }
            });
            request.send();
        }

        let modules = document.getElementsByClassName("module_list_item");
        for (let i=0; i < modules.length; i++) {
            const check_module = new XMLHttpRequest();
            const check_url = "http://127.0.0.1:8000/course/module/" + modules[i].getAttribute("data-id").toString() + "/check_finished/";
            check_module.open('GET', check_url);
            check_module.setRequestHeader('Content-Type', 'application/json');

            check_module.addEventListener("readystatechange", () => {
                if (check_module.readyState === 4 && check_module.status === 200) {
                    let resp = JSON.parse(check_module.responseText);

                    if (resp["response"] === true) {
                        modules[i].style.backgroundColor = "#3fad37";
                    }
                }
            });
            check_module.send();
        }

        // Gains and parses comments tree
            const gain_comments_request = new XMLHttpRequest();
            const gain_comments_url = "http://127.0.0.1:8000/communicate/course/module/" + module_id.toString() + "/get_comments/";
            gain_comments_request.open('GET', gain_comments_url);
            gain_comments_request.setRequestHeader('Content-Type', 'application/json');

            gain_comments_request.addEventListener("readystatechange", () => {
                if (gain_comments_request.readyState === 4 && gain_comments_request.status === 200) {
                    let comments_json = JSON.parse(gain_comments_request.responseText);
                    console.log(comments_json);
                    let threads_keys = Object.keys(comments_json);
                    for (let i=0; i < threads_keys.length; i++) {
                        parse_comments_json(comments_json[threads_keys[i].toString()], 0)
                    }

                }
            });
            gain_comments_request.send();


            function parse_comments_json(comment, offset) {
                let comments_div = document.getElementById("comments");
                let div = document.createElement("div");
                div.className = "comment";
                div.style.border = "solid 1px";
                div.style.display = "flex";
                div.style.flexDirection = "column";
                div.style.margin = "15px " + "15px " + "15px " + (50 * offset).toString() + "px";
                div.style.padding = "15px";

                let p_title = document.createElement("p");
                p_title.innerText = comment["content"]["username"].toString() +
                    " (" + comment["content"]["date"].toString() + ")";

                let p_text = document.createElement("p");
                p_text.innerText = comment["content"]["text"];

                let btn_like = document.createElement("button");
                btn_like.innerText = "+ (" + comment["content"]["likes"].toString() + ")";
                btn_like.style.width = "50px";
                btn_like.style.height = "20px";
                if (comment["content"]["my_vote"] === true) {
                    btn_like.style.fontWeight = "bold";
                }
                btn_like.addEventListener("click", function () {
                    const change_vote_request = new XMLHttpRequest();
                    let change_vote_url = "";
                    //change_vote_request.open('GET', change_vote_url);

                    change_vote_request.addEventListener("readystatechange", () => {
                        if (change_vote_request.readyState === 4 && change_vote_request.status === 200) {
                            console.log("REQUEST WAS SENT!");
                        }
                    });
                    if (comment["content"]["my_vote"] === null) {
                        console.log("ANY PROBLEMS?");
                        change_vote_request.open("GET", "http://127.0.0.1:8000/communicate/comment/" + comment["content"]["id"] + "/add_comment_vote/like/");
                        change_vote_request.setRequestHeader('Content-Type', 'text/html');
                        change_vote_request.send();
                    } else if (comment["content"]["my_vote"] === true) {
                        change_vote_request.open("GET", "http://127.0.0.1:8000/communicate/comment/" + comment["content"]["id"] + "/delete_comment_vote/");
                        change_vote_request.setRequestHeader('Content-Type', 'text/html');
                        change_vote_request.send();
                    } else if (comment["content"]["my_vote"] === false) {
                        // Delete dislike request and add like request
                        console.log('Was dislike but here is like now');
                        change_vote_request.open("GET", "http://127.0.0.1:8000/communicate/comment/" + comment["content"]["id"] + "/change_comment_vote/");
                        change_vote_request.setRequestHeader('Content-Type', 'text/html');
                        change_vote_request.send();
                    }


                });


                let btn_dislike = document.createElement("button");
                btn_dislike.innerText = "- (" + comment["content"]["dislikes"].toString() + ")";
                btn_dislike.style.width = "50px";
                btn_dislike.style.height = "20px";
                if (comment["content"]["my_vote"] === false) {
                    btn_dislike.style.fontWeight = "bold";
                }
                btn_dislike.addEventListener("click", function () {
                    const change_vote_request = new XMLHttpRequest();
                    let change_vote_url = "";
                    //change_vote_request.open('GET', change_vote_url);

                    change_vote_request.addEventListener("readystatechange", () => {
                        if (change_vote_request.readyState === 4 && change_vote_request.status === 200) {
                            console.log("REQUEST WAS SENT!");
                        }
                    });
                    if (comment["content"]["my_vote"] === null) {
                        console.log("ANY PROBLEMS?");
                        change_vote_request.open("GET", "http://127.0.0.1:8000/communicate/comment/" + comment["content"]["id"] + "/add_comment_vote/dislike/");
                        change_vote_request.setRequestHeader('Content-Type', 'text/html');
                        change_vote_request.send();
                    } else if (comment["content"]["my_vote"] === false) {
                        change_vote_request.open("GET", "http://127.0.0.1:8000/communicate/comment/" + comment["content"]["id"] + "/delete_comment_vote/");
                        change_vote_request.setRequestHeader('Content-Type', 'text/html');
                        change_vote_request.send();
                    } else if (comment["content"]["my_vote"] === true) {
                        // Delete dislike request and add like request
                        console.log('Was dislike but here is like now');
                        change_vote_request.open("GET", "http://127.0.0.1:8000/communicate/comment/" + comment["content"]["id"] + "/change_comment_vote/");
                        change_vote_request.setRequestHeader('Content-Type', 'text/html');
                        change_vote_request.send();
                    }


                });

                let btn_reply = document.createElement("a");
                btn_reply.innerText = "Reply";
                btn_reply.addEventListener("click", function () {
                    let reply_form = document.getElementById("reply_form");
                    if (reply_form !== null) {
                        comments_div.removeChild(reply_form);
                    } else {
                        let new_reply_div = document.createElement("div");

                        new_reply_div.innerHTML = '<form id="reply_form" action="{% url 'add_comment' module_id%}" method="POST">' +
                            '<input type="hidden" name="replies_to" value="'+ comment["content"]["id"].toString() +'"/>' +
                            '<textarea name="text" form="reply_form"></textarea>' +
                            '{% csrf_token %}' + '<input type="submit" value="Reply"/>' + "</form>";
                        div.insertAdjacentHTML("afterend", new_reply_div.innerHTML);
                    }
                });


                div.appendChild(p_title);
                div.appendChild(p_text);
                div.appendChild(btn_like);
                div.appendChild(btn_dislike);
                div.appendChild(btn_reply);

                let user_id = {{ user.id }};
                if (comment["content"]["user_id"] === user_id) {
                    let btn_edit = document.createElement("a");
                    btn_edit.innerText = "Edit";
                    btn_edit.addEventListener("click", function () {
                        let edit_form = document.createElement("div");
                        edit_form.innerHTML = '<form id="reply_form" action="http://127.0.0.1:8000/communicate/comment/'+
                            comment["content"]["id"] +'/edit_comment/" method="POST">' +
                                '<input type="hidden" name="id" value="'+ comment["content"]["id"].toString() +'"/>' +
                                '<textarea name="text" form="reply_form">' + comment['content']['text'] + '</textarea>' +
                                '{% csrf_token %}' + '<input type="submit" value="Save"/>' + "</form>";
                        p_text.insertAdjacentHTML("beforebegin", edit_form.innerHTML);
                        div.removeChild(p_text);
                    });
                    div.appendChild(btn_edit);
                }
                comments_div.appendChild(div);

                if (comment["replies"] !== null) {
                    let replies_titles = Object.keys(comment["replies"]);
                    for (let i=0; i < replies_titles.length; i++) {
                        parse_comments_json(comment["replies"][replies_titles[i].toString()], offset+1)
                    }
                }

            }
    </script>
{% endblock %}
